{% extends "base.html" %} {% block content %}
<div id="map" style="height: 70vh; width: 70vw; margin: auto auto"></div>
<button id="addMarker" class="button">Add Marker</button>
<button id="toggleUnit" class="button">Switch to Miles</button>
<button id="saveMarker" class="button">Save the marker</button>


{{ pins|json_script:"pins_json" }}

<script>
  let map = L.map("map", { attributionControl: false });
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxzoom: 19,
  }).addTo(map);

  let control;
  let addMarker = false;
  let marker;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      let userLocation = L.latLng(
        position.coords.latitude,
        position.coords.longitude
      );
      map.setView(userLocation, 13);

      // create a routing control
      control = L.Routing.control({
        waypoints: [userLocation],
        routeWhileDragging: false,
        geocoder: L.Control.Geocoder.nominatim(),
        }).addTo(map);

      let pins = JSON.parse(document.getElementById("pins_json").textContent);
      console.log("pins", pins);

      let pinStore = {};

      pins.forEach((pin) => {
        pinStore[pin.id] = {
          data: pin,
          marker: L.marker([pin.latitude, pin.longitude]),
        };
        let pinMarker = pinStore[pin.id].marker;

        let popupString = `<b>${pin.title}</b> <br><br> ${pin.description} <br><br> LA : ${pin.latitude} <br> LO : ${pin.longitude} <br><br>`;
        let tags = pin.tags.split(", ");
        tags.forEach((tag) => {
          popupString = popupString + `${tag} <br>`;
        });

        pinMarker.bindPopup(popupString);
        pinMarker.addTo(map);

        // Add a click event listener to the marker
        pinMarker.on('click', function(e) {
          // Add a waypoint to the control at the marker's location
          control.spliceWaypoints(control.getWaypoints().length - 1, 1, e.latlng);
        });
      });
      console.log("pinStore", pinStore);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          let userLocation = L.latLng(
            position.coords.latitude,
            position.coords.longitude
          );
          L.marker(userLocation).addTo(map);
        });
      } else {
        // Browser doesn't support Geolocation
        alert("Geolocation is not supported by your browser.");
      }

      let unit = "km"; // default unit is miles

      pins.forEach((pin) => {
        let pinLocation = L.latLng(pin.latitude, pin.longitude);
        let distance = userLocation.distanceTo(pinLocation) / 1000; // distance in km
        if (unit === "miles") {
          distance *= 0.621371; // convert km to miles
        }
        L.marker([pin.latitude, pin.longitude])
          .addTo(map)
          .bindPopup(
            pin.pin +
              `<br/>The distance to this pin is ${distance.toFixed(2)} ${unit}.`
          );
      });

      let addMarker = false;

      document
        .getElementById("addMarker")
        .addEventListener("click", function () {
          addMarker = true;
        });

      map.on("click", function (e) {
        if (addMarker) {
          // Remove the previous marker if it exists
          if (marker) {
            map.removeLayer(marker);
          }

          // Add a new marker
          marker = L.marker(e.latlng).addTo(map);

          // Add a new waypoint to the routing control
          control.setWaypoints([
            control.getWaypoints()[0], // keep the user's location as the first waypoint
            e.latlng, // add the clicked location as the second waypoint
          ]);

          addMarker = false;
        }
      });
      document
        .getElementById("saveMarker")
        .addEventListener("click", function () {
          addMarker = true;
          if (marker) {
            console.log("Marker:", marker);
            const markerData = {
              lat: marker.getLatLng().lat,
              lng: marker.getLatLng().lng,
            };

            fetch("http://127.0.0.1:8000/api/save-marker", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(markerData),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log("Success:", data);
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          } else {
            console.log("No marker to save");
          }
        });
    });
  } else {
    // Browser doesn't support Geolocation
    alert("Geolocation is not supported by your browser.");
  }

  // Add a click event listener to the map
  map.on("click", function (e) {
    // Add a new waypoint to the routing control
    control.setWaypoints([
      control.getWaypoints()[0], // keep the user's location as the first waypoint
      e.latlng, // add the clicked location as the second waypoint
    ]);
  });
</script>
{% endblock %}
