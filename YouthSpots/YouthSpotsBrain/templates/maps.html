{% extends "base.html" %} {% block content %}
<div id="map" style="height: 70vh; width: 70vw; margin: auto auto"></div>
<div class="button-wrapper">
  <button id="addMarker" class="button">Add Marker</button>
  <button id="saveMarker" class="button">Save the marker</button>
</div>

{{ pins|json_script:"pins_json" }}

<script>
  let map = L.map("map", { attributionControl: false });
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxzoom: 19,
  }).addTo(map);

  let control;
  let addMarker = false;
  let marker;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      let userLocation = L.latLng(
        position.coords.latitude,
        position.coords.longitude
      );
      map.setView(userLocation, 13);
      // create a routing control
      control = L.Routing.control({
        waypoints: [userLocation],
        routeWhileDragging: false,
        fitSelectedRoutes: false,
        reverseWaypoints: true,
        geocoder: L.Control.Geocoder.nominatim(),
        router: new L.Routing.osrmv1({
          language: "en",
          profile: "car",
        }),
        waypointNameFallback: function (latLng) {
          function zeroPad(n) {
            n = Math.round(n);
            return  10 ? "0" + n : n;
          }
          function sexagesimal(p, pos, neg) {
            var n = Math.abs(p),
              degs = Math.floor(n),
              mins = (n - degs) * 60,
              secs = (mins - Math.floor(mins)) * 60,
              frac = Math.round((secs - Math.floor(secs)) * 100);
            return (
              (n >= 0 ? pos : neg) +
              degs +
              "°" +
              zeroPad(mins) +
              "'" +
              zeroPad(secs) +
              "." +
              zeroPad(frac) +
              '"'
            );
          }

          return (
            sexagesimal(latLng.lat, "N", "S") +
            " " +
            sexagesimal(latLng.lng, "E", "W")
          );
        },
      }).addTo(map);
      let ReversablePlan = L.Routing.Plan.extend({
        createGeocoders: function () {
          let container = L.Routing.Plan.prototype.createGeocoders.call(this),
            reverseButton = createButton("↑↓", container);

          L.DomEvent.on(
            reverseButton,
            "click",
            function () {
              let waypoints = this.getWaypoints();
              this.setWaypoints(waypoints.reverse());
            },
            this
          );

          return container;
        },
      });
      let pins = JSON.parse(document.getElementById("pins_json").textContent);
      console.log("pins", pins);

      let pinStore = {};

      pins.forEach((pin) => {
        pinStore[pin.id] = {
          data: pin,
          marker: L.marker([pin.latitude, pin.longitude]),
        };
        let pinMarker = pinStore[pin.id].marker;

        let popupString = `<b>${pin.title}</b> <br><br> ${pin.description} <br><br> LA : ${pin.latitude} <br> LO : ${pin.longitude} <br><br>`;
        let tags = pin.tags.split(", ");
        tags.forEach((tag) => {
          popupString = popupString + `${tag} <br>`;
        });

        pinMarker.bindPopup(popupString);
        pinMarker.addTo(map);

        // Add a click event listener to the marker
        pinMarker.on("click", function (e) {
          // Add a waypoint to the control at the marker's location
          control.spliceWaypoints(
            control.getWaypoints().length - 1,
            1,
            e.latlng
          );
        });
      });
      console.log("pinStore", pinStore);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          let userLocation = L.latLng(
            position.coords.latitude,
            position.coords.longitude
          );
          L.marker(userLocation).addTo(map);
        });
      } else {
        // Browser doesn't support Geolocation
        alert("Geolocation is not supported by your browser.");
      }

      document
        .getElementById("addMarker")
        .addEventListener("click", function () {
          addMarker = true;
        });

      map.on("click", function (e) {
        if (addMarker) {
          // Remove the previous marker if it exists
          if (marker) {
            map.removeLayer(marker);
          }

          // Add a new marker
          marker = L.marker(e.latlng, { icon: myIcon }).addTo(map);

          // Add a new waypoint to the routing control
          control.setWaypoints([
            control.getWaypoints()[0], // keep the user's location as the first waypoint
            e.latlng, // add the clicked location as the second waypoint
          ]);

          addMarker = false;
        }

        var container = L.DomUtil.create("div"),
          startBtn = createButton("Start from this location", container),
          destBtn = createButton("Go to this location", container);

        L.popup().setContent(container).setLatLng(e.latlng).openOn(map);

        L.DomEvent.on(startBtn, "click", function () {
          control.spliceWaypoints(0, 1, e.latlng);
          map.closePopup();
        });

        L.DomEvent.on(destBtn, "click", function () {
          control.spliceWaypoints(
            control.getWaypoints().length - 1,
            1,
            e.latlng
          );
          map.closePopup();
        });
      });
      document
        .getElementById("saveMarker")
        .addEventListener("click", function () {
          // addMarker = true;
          if (marker) {
            console.log("Marker:", marker);
            const markerData = {
              lat: marker.getLatLng().lat,
              lng: marker.getLatLng().lng,
            };

            fetch("http://127.0.0.1:8000/api/save-marker", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(markerData),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log("Success:", data);
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          } else {
            console.log("No marker to save");
          }
        });
    });
  } else {
    // Browser doesn't support Geolocation
    alert("Geolocation is not supported by your browser.");
  }

  function createButton(label, container) {
    var btn = L.DomUtil.create("button", "", container);
    btn.setAttribute("type", "button");
    btn.innerHTML = label;
    return btn;
  }
</script>
{% endblock %}
